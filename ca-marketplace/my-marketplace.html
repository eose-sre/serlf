<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://buy.stripe.com https://billing.stripe.com; frame-src https://buy.stripe.com">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">
<title>serlf.ca ‚Äî My Marketplace</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e1a;color:#e0e4ef;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh}
/* Top bar */
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1.5rem;background:#0d1220;border-bottom:1px solid #1a2040;position:sticky;top:0;z-index:100}
.top-left{display:flex;align-items:center;gap:1rem}
.logo{font-size:1.3rem;font-weight:700;color:#ff6b6b}
.greeting{color:#8892b0;font-size:.9rem}
.top-right{display:flex;align-items:center;gap:1rem}
.product-count{background:#ff6b6b22;color:#ff6b6b;padding:.3rem .75rem;border-radius:20px;font-size:.8rem;font-weight:600}
.nav-link{color:#8892b0;text-decoration:none;font-size:.85rem;transition:color .2s}
.nav-link:hover{color:#ff6b6b}
.logout-btn{background:none;border:1px solid #2a3050;color:#8892b0;padding:.35rem .75rem;border-radius:6px;cursor:pointer;font-size:.8rem}
.logout-btn:hover{border-color:#ff6b6b;color:#ff6b6b}
/* Layout */
.main-layout{display:flex;height:calc(100vh - 52px)}
.content-area{flex:1;overflow-y:auto;padding:1.5rem}
/* Categories */
.category-filters{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.5rem}
.cat-btn{background:#151b2e;border:1px solid #2a3050;color:#8892b0;padding:.4rem .85rem;border-radius:20px;cursor:pointer;font-size:.8rem;transition:all .2s}
.cat-btn:hover,.cat-btn.active{background:#ff6b6b22;border-color:#ff6b6b;color:#ff6b6b}
/* Product grid */
.section-title{font-size:1.1rem;color:#8892b0;margin-bottom:1rem;text-transform:uppercase;letter-spacing:.05em}
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
.product-card{background:#151b2e;border:1px solid #2a3050;border-radius:12px;padding:1.2rem;transition:all .2s;cursor:default}
.product-card:hover{border-color:#ff6b6b44;transform:translateY(-2px)}
.product-card.owned{border-color:#ff6b6b33;background:#151b2e}
.product-icon{font-size:2rem;margin-bottom:.5rem}
.product-card h3{font-size:1rem;margin-bottom:.3rem;color:#e0e4ef}
.product-card p{font-size:.8rem;color:#8892b0;margin-bottom:.75rem}
.buy-btn{background:#ff6b6b;color:#fff;border:none;padding:.4rem .85rem;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s}
.buy-btn:hover{background:#ff5252}
.badge{padding:.35rem .75rem;border-radius:6px;font-size:.75rem;font-weight:600}
.badge.owned{background:#ff6b6b22;color:#ff6b6b}
/* Silos section */
.silos-section{margin-top:1rem}
.silo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.75rem}
.silo-card{background:#151b2e;border:1px solid #ff6b6b33;border-radius:10px;padding:1rem;display:flex;align-items:center;gap:.75rem;cursor:pointer;transition:all .2s}
.silo-card:hover{background:#1a2040}
.silo-emoji{font-size:1.5rem}
.silo-info .silo-name{font-weight:600;font-size:.9rem}
.silo-info .silo-status{font-size:.75rem;color:#8892b0}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:.3rem}
.status-dot.sleeping{background:#4a5080}
.status-dot.awake{background:#ff6b6b;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
/* Chat panel */
.chat-panel{width:360px;background:#0d1220;border-left:1px solid #1a2040;display:flex;flex-direction:column;transition:width .3s}
.chat-panel.collapsed{width:48px}
.chat-panel.collapsed .chat-body,.chat-panel.collapsed .chat-input-area,.chat-panel.collapsed .chat-title-text{display:none}
.chat-header{padding:.75rem 1rem;border-bottom:1px solid #1a2040;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.chat-title-text{font-weight:600;font-size:.9rem}
.chat-toggle{background:none;border:none;color:#8892b0;font-size:1.2rem;cursor:pointer}
.chat-body{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.75rem}
.chat-msg{max-width:85%;padding:.65rem .85rem;border-radius:12px;font-size:.9rem;line-height:1.4;animation:msgIn .3s}
.chat-msg.specialist{background:#151b2e;align-self:flex-start;border:1px solid #2a3050}
.chat-msg.user{background:#ff6b6b22;align-self:flex-end;border:1px solid #ff6b6b33}
.chat-msg .sender{font-size:.7rem;color:#8892b0;margin-bottom:.2rem}
.typing-indicator{align-self:flex-start;color:#8892b0;font-size:.8rem;font-style:italic;display:none}
.typing-indicator.show{display:block}
.typing-dots span{animation:blink 1.4s infinite;opacity:.2}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{20%{opacity:1}100%{opacity:.2}}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.chat-input-area{padding:.75rem;border-top:1px solid #1a2040;display:flex;gap:.5rem}
.chat-input-area input{flex:1;padding:.6rem .85rem;background:#151b2e;border:1px solid #2a3050;border-radius:8px;color:#e0e4ef;font-size:.9rem}
.chat-input-area input:focus{outline:none;border-color:#ff6b6b}
.chat-send{background:#ff6b6b;color:#fff;border:none;padding:.6rem .85rem;border-radius:8px;cursor:pointer;font-weight:600}
@media(max-width:768px){
  .chat-panel{position:fixed;right:0;top:52px;bottom:0;z-index:50;width:100%}
  .chat-panel.collapsed{width:48px}
  .product-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
}
</style>
</head>
<body>
<div id="top-bar"></div>
<div class="main-layout">
  <div class="content-area">
    <div class="category-filters" id="filters"></div>
    <div class="section-title">üè™ All Products</div>
    <div class="product-grid" id="product-grid"></div>
    <div class="silos-section">
      <div class="section-title">üß† Your Specialist Silos</div>
      <div class="silo-grid" id="silo-grid"></div>
    </div>
  </div>
  <div class="chat-panel" id="chat-panel">
    <div class="chat-header" onclick="toggleChat()">
      <span class="chat-title-text">üß≠ Captain ‚Äî Your Specialist</span>
      <button class="chat-toggle" id="chat-toggle">‚óÄ</button>
    </div>
    <div class="chat-body" id="chat-body">
      <div class="typing-indicator" id="typing">
        <span class="typing-dots"><span>‚óè</span><span>‚óè</span><span>‚óè</span></span> Captain is typing...
      </div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="chat-input" placeholder="Talk to Captain..." onkeydown="if(event.key==='Enter')sendChat()">
      <button class="chat-send" onclick="sendChat()">‚Üí</button>
    </div>
  </div>
</div>

<script src="../shared/auth.js"></script>
<script src="../shared/specialist-engine.js"></script>
<script src="../shared/marketplace-ui.js"></script>
<script src="../shared/stripe-flow.js"></script>
<script>
if (!SerlfAuth.requireAuth()) throw 'auth';
const user = SerlfAuth.getUser();
const DOMAIN = 'ca';

// Top bar
document.getElementById('top-bar').innerHTML = MarketplaceUI.renderTopBar(user, DOMAIN);

// Filters
const categories = ['all','core','data','security','creative','ops','finance','marketing','oss','support','research'];
let activeFilter = 'all';
function renderFilters() {
  document.getElementById('filters').innerHTML = categories.map(c =>
    `<button class="cat-btn ${c===activeFilter?'active':''}" onclick="filterCategory('${c}')">${c}</button>`
  ).join('');
}
function filterCategory(cat) {
  activeFilter = cat;
  renderFilters();
  refreshGrid();
}

// Product grid
function refreshGrid() {
  const owned = user.ownedProducts || [];
  const products = MarketplaceUI.getProductsForDomain(DOMAIN);
  const filtered = activeFilter === 'all' ? products : products.filter(([,p]) => p.category === activeFilter);
  document.getElementById('product-grid').innerHTML = filtered.map(([id, p]) =>
    MarketplaceUI.renderProductCard(id, p, owned.includes(id))
  ).join('');
  document.getElementById('top-bar').innerHTML = MarketplaceUI.renderTopBar(SerlfAuth.getUser(), DOMAIN);
  renderSilos();
}

// Silos
function renderSilos() {
  const owned = (SerlfAuth.getUser()?.ownedProducts || []);
  const specMap = { core:'user-specialist', data:'data-specialist', security:'security-specialist', creative:'creative-specialist', ops:'ops-specialist', finance:'finance-specialist', marketing:'marketing-specialist', oss:'code-specialist', support:'support-specialist', research:'research-specialist' };
  const activeSpecs = new Set();
  owned.forEach(pid => {
    const p = MarketplaceUI.products[pid];
    if (p) activeSpecs.add(specMap[p.category] || 'user-specialist');
  });
  const html = [...activeSpecs].map(sid => {
    const s = SpecialistEngine.specialists[sid];
    if (!s) return '';
    const state = SpecialistEngine.getState(sid);
    return `<div class="silo-card" onclick="window.location.href='my-specialist.html?s=${sid}'">
      <span class="silo-emoji">${s.emoji}</span>
      <div class="silo-info">
        <div class="silo-name">${s.name}</div>
        <div class="silo-status"><span class="status-dot ${state}"></span>${state}</div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('silo-grid').innerHTML = html || '<p style="color:#4a5080;font-size:.85rem">Buy products to unlock specialist silos</p>';
}

// Chat
function toggleChat() {
  const panel = document.getElementById('chat-panel');
  panel.classList.toggle('collapsed');
  document.getElementById('chat-toggle').textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
}

function addChatMsg(text, role, sender) {
  const body = document.getElementById('chat-body');
  const typing = document.getElementById('typing');
  const div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  div.innerHTML = (sender ? `<div class="sender">${sender}</div>` : '') + text;
  body.insertBefore(div, typing);
  body.scrollTop = body.scrollHeight;
}

function showSpecialistMessage(text, specId) {
  const spec = SpecialistEngine.specialists[specId];
  addChatMsg(text, 'specialist', spec ? `${spec.emoji} ${spec.name}` : 'üß≠ Captain');
}

async function sendChat() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  addChatMsg(msg, 'user');

  const typing = document.getElementById('typing');
  typing.classList.add('show');

  const result = await SpecialistEngine.chat('user-specialist', msg, user);
  typing.classList.remove('show');
  showSpecialistMessage(result.text, 'user-specialist');
}

// Init
renderFilters();
refreshGrid();

// Welcome message
setTimeout(() => {
  SpecialistEngine.wake('user-specialist');
  const greeting = SpecialistEngine.getFirstMeetGreeting('user-specialist', user);
  showSpecialistMessage(greeting, 'user-specialist');
}, 500);
</script>
</body>
</html>
