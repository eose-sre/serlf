<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://buy.stripe.com https://billing.stripe.com; frame-src https://buy.stripe.com">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">
<title>serlf.ca — My Specialist</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e1a;color:#e0e4ef;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;height:100vh;display:flex;flex-direction:column}
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1.5rem;background:#0d1220;border-bottom:1px solid #1a2040}
.top-left{display:flex;align-items:center;gap:1rem}
.logo{font-size:1.3rem;font-weight:700;color:#ff6b6b}
.back-link{color:#8892b0;text-decoration:none;font-size:.85rem}
.back-link:hover{color:#ff6b6b}
.specialist-layout{display:flex;flex:1;overflow:hidden}
/* Sidebar */
.spec-sidebar{width:240px;background:#0d1220;border-right:1px solid #1a2040;overflow-y:auto;padding:.75rem}
.spec-sidebar h3{font-size:.8rem;color:#8892b0;text-transform:uppercase;letter-spacing:.05em;padding:.5rem .75rem}
.spec-item{display:flex;align-items:center;gap:.65rem;padding:.65rem .75rem;border-radius:8px;cursor:pointer;transition:all .2s;margin-bottom:.25rem}
.spec-item:hover,.spec-item.active{background:#151b2e}
.spec-item.active{border-left:3px solid #ff6b6b}
.spec-item .emoji{font-size:1.3rem}
.spec-item .info{flex:1}
.spec-item .name{font-size:.85rem;font-weight:600}
.spec-item .role{font-size:.7rem;color:#8892b0}
.spec-item .dot{width:8px;height:8px;border-radius:50%}
.dot.sleeping{background:#4a5080}
.dot.awake{background:#ff6b6b;animation:pulse 2s infinite}
.dot.chatting{background:#4ade80;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
/* Chat area */
.chat-area{flex:1;display:flex;flex-direction:column}
.chat-header-bar{padding:1rem 1.5rem;border-bottom:1px solid #1a2040;display:flex;align-items:center;gap:1rem}
.chat-avatar{font-size:2.5rem}
.chat-spec-info h2{font-size:1.1rem;margin-bottom:.15rem}
.chat-spec-info p{font-size:.8rem;color:#8892b0}
.wake-btn{margin-left:auto;background:#ff6b6b;color:#fff;border:none;padding:.5rem 1.2rem;border-radius:8px;cursor:pointer;font-weight:600;display:none}
.chat-messages{flex:1;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:.75rem}
.msg{max-width:70%;padding:.75rem 1rem;border-radius:14px;font-size:.9rem;line-height:1.45;animation:msgIn .3s}
.msg.specialist{background:#151b2e;border:1px solid #2a3050;align-self:flex-start}
.msg.user{background:#ff6b6b22;border:1px solid #ff6b6b33;align-self:flex-end}
.msg .sender{font-size:.7rem;color:#8892b0;margin-bottom:.2rem}
.msg .time{font-size:.65rem;color:#4a5080;margin-top:.3rem;text-align:right}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.typing-indicator{align-self:flex-start;color:#8892b0;font-size:.8rem;font-style:italic;display:none}
.typing-indicator.show{display:block}
.typing-dots span{animation:blink 1.4s infinite;opacity:.2}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{20%{opacity:1}100%{opacity:.2}}
.chat-input-bar{padding:1rem 1.5rem;border-top:1px solid #1a2040;display:flex;gap:.75rem}
.chat-input-bar input{flex:1;padding:.75rem 1rem;background:#151b2e;border:1px solid #2a3050;border-radius:10px;color:#e0e4ef;font-size:.95rem}
.chat-input-bar input:focus{outline:none;border-color:#ff6b6b}
.send-btn{background:#ff6b6b;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:10px;cursor:pointer;font-weight:600;font-size:1rem}
/* Wake animation */
.wake-overlay{position:fixed;inset:0;background:rgba(10,14,26,.9);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .5s}
.wake-overlay.show{opacity:1;pointer-events:auto}
.wake-content{text-align:center;animation:wakeAnim 1.5s}
.wake-emoji{font-size:5rem;margin-bottom:1rem}
.wake-name{font-size:1.8rem;font-weight:700;color:#ff6b6b;margin-bottom:.5rem}
.wake-msg{color:#8892b0;font-size:1rem}
@keyframes wakeAnim{0%{opacity:0;transform:scale(.8)}50%{transform:scale(1.05)}100%{opacity:1;transform:scale(1)}}
/* Products in chat */
.product-browser{padding:1rem;border-top:1px solid #1a2040;display:none}
.product-browser.show{display:block}
.product-browser h4{font-size:.8rem;color:#8892b0;margin-bottom:.5rem;text-transform:uppercase}
.mini-products{display:flex;gap:.5rem;overflow-x:auto;padding-bottom:.5rem}
.mini-product{background:#151b2e;border:1px solid #2a3050;border-radius:8px;padding:.5rem .75rem;white-space:nowrap;font-size:.8rem;cursor:pointer;transition:all .2s;flex-shrink:0}
.mini-product:hover{border-color:#ff6b6b}
@media(max-width:768px){
  .spec-sidebar{display:none}
  .msg{max-width:90%}
}
</style>
</head>
<body>
<div class="top-bar">
  <div class="top-left">
    <span class="logo">serlf.ca</span>
    <a href="my-marketplace.html" class="back-link">← Marketplace</a>
  </div>
</div>
<div class="specialist-layout">
  <div class="spec-sidebar" id="sidebar"></div>
  <div class="chat-area">
    <div class="chat-header-bar" id="chat-header"></div>
    <div class="chat-messages" id="messages">
      <div class="typing-indicator" id="typing"><span class="typing-dots"><span>●</span><span>●</span><span>●</span></span> typing...</div>
    </div>
    <div class="product-browser" id="product-browser">
      <h4>Browse Products</h4>
      <div class="mini-products" id="mini-products"></div>
    </div>
    <div class="chat-input-bar">
      <input type="text" id="chat-input" placeholder="Say something..." onkeydown="if(event.key==='Enter')sendMsg()">
      <button class="send-btn" onclick="sendMsg()">Send</button>
    </div>
  </div>
</div>
<div class="wake-overlay" id="wake-overlay">
  <div class="wake-content">
    <div class="wake-emoji" id="wake-emoji"></div>
    <div class="wake-name" id="wake-name"></div>
    <div class="wake-msg" id="wake-msg"></div>
  </div>
</div>

<script src="../shared/auth.js"></script>
<script src="../shared/specialist-engine.js"></script>
<script src="../shared/marketplace-ui.js"></script>
<script>
if (!SerlfAuth.requireAuth()) throw 'auth';
const user = SerlfAuth.getUser();
let activeSpec = new URLSearchParams(location.search).get('s') || 'user-specialist';

function getOwnedSpecs() {
  const specMap = {core:'user-specialist',data:'data-specialist',security:'security-specialist',creative:'creative-specialist',ops:'ops-specialist',finance:'finance-specialist',marketing:'marketing-specialist',oss:'code-specialist',support:'support-specialist',research:'research-specialist'};
  const specs = new Set(['user-specialist']);
  (user.ownedProducts||[]).forEach(pid => {
    const p = MarketplaceUI.products[pid];
    if (p) specs.add(specMap[p.category]||'user-specialist');
  });
  return [...specs];
}

function renderSidebar() {
  const owned = getOwnedSpecs();
  document.getElementById('sidebar').innerHTML = '<h3>Your Specialists</h3>' + owned.map(sid => {
    const s = SpecialistEngine.specialists[sid];
    if(!s) return '';
    const state = SpecialistEngine.getState(sid);
    return `<div class="spec-item ${sid===activeSpec?'active':''}" onclick="switchSpec('${sid}')">
      <span class="emoji">${s.emoji}</span>
      <div class="info"><div class="name">${s.name}</div><div class="role">${s.role}</div></div>
      <div class="dot ${state}"></div>
    </div>`;
  }).join('');
}

function renderHeader() {
  const s = SpecialistEngine.specialists[activeSpec];
  if(!s) return;
  const state = SpecialistEngine.getState(activeSpec);
  document.getElementById('chat-header').innerHTML = `
    <div class="chat-avatar">${s.emoji}</div>
    <div class="chat-spec-info"><h2>${s.name}</h2><p>${s.role} · <span class="dot ${state}" style="display:inline-block;vertical-align:middle"></span> ${state}</p></div>
    ${state==='sleeping'?`<button class="wake-btn" style="display:block" onclick="wakeSpec()">Wake Up</button>`:''}
  `;
}

function renderHistory() {
  const msgs = document.getElementById('messages');
  const typing = document.getElementById('typing');
  // Clear except typing
  [...msgs.children].forEach(c => { if(c!==typing) msgs.removeChild(c); });
  const history = SpecialistEngine.getHistory(activeSpec);
  history.forEach(h => {
    const div = document.createElement('div');
    div.className = 'msg ' + (h.role==='user'?'user':'specialist');
    const s = SpecialistEngine.specialists[activeSpec];
    div.innerHTML = (h.role!=='user'?`<div class="sender">${s?.emoji||''} ${s?.name||''}</div>`:'')+h.text+`<div class="time">${new Date(h.ts).toLocaleTimeString()}</div>`;
    msgs.insertBefore(div, typing);
  });
  msgs.scrollTop = msgs.scrollHeight;
}

function switchSpec(sid) {
  activeSpec = sid;
  renderSidebar();
  renderHeader();
  renderHistory();
  if(SpecialistEngine.getState(sid)==='sleeping') wakeSpec();
}

function wakeSpec() {
  const s = SpecialistEngine.wake(activeSpec);
  const overlay = document.getElementById('wake-overlay');
  document.getElementById('wake-emoji').textContent = s.emoji;
  document.getElementById('wake-name').textContent = s.name + ' is waking up...';
  document.getElementById('wake-msg').textContent = s.role;
  overlay.classList.add('show');
  setTimeout(() => {
    overlay.classList.remove('show');
    renderHeader();
    renderSidebar();
    const greeting = SpecialistEngine.getFirstMeetGreeting(activeSpec, user);
    addMsg(greeting, 'specialist');
  }, 2000);
}

function addMsg(text, role) {
  const msgs = document.getElementById('messages');
  const typing = document.getElementById('typing');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  if(role==='specialist'){
    const s = SpecialistEngine.specialists[activeSpec];
    div.innerHTML = `<div class="sender">${s?.emoji||''} ${s?.name||''}</div>${text}<div class="time">${new Date().toLocaleTimeString()}</div>`;
  } else {
    div.innerHTML = text+`<div class="time">${new Date().toLocaleTimeString()}</div>`;
  }
  msgs.insertBefore(div, typing);
  msgs.scrollTop = msgs.scrollHeight;
}

async function sendMsg() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if(!msg) return;
  input.value = '';
  addMsg(msg, 'user');
  document.getElementById('typing').classList.add('show');
  const result = await SpecialistEngine.chat(activeSpec, msg, user);
  document.getElementById('typing').classList.remove('show');
  addMsg(result.text, 'specialist');
  renderSidebar();
  renderHeader();
}

// Mini product browser
function renderMiniProducts() {
  const products = MarketplaceUI.getProductsForDomain('ca');
  document.getElementById('mini-products').innerHTML = products.slice(0,15).map(([id,p]) =>
    `<div class="mini-product" onclick="MarketplaceUI.buyProduct('${id}')">${p.icon} ${p.name} · $${p.price}</div>`
  ).join('');
  document.getElementById('product-browser').classList.add('show');
}

// Init
renderSidebar();
renderHeader();
renderHistory();
renderMiniProducts();
if(SpecialistEngine.getState(activeSpec)==='sleeping') {
  setTimeout(()=>wakeSpec(), 300);
}
function showSpecialistMessage(t){addMsg(t,'specialist');}
function refreshGrid(){}
</script>
</body>
</html>
