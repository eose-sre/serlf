<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://buy.stripe.com https://billing.stripe.com; frame-src https://buy.stripe.com">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">
<title>serlf.shop ‚Äî My Marketplace</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e1a;color:#e0e0e0;font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh}
.top-bar{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:#111827;border-bottom:1px solid #1e293b;position:sticky;top:0;z-index:100}
.top-left .logo{font-size:1.3rem;font-weight:800;color:#ffd740}.logo .domain{color:#4caf50}
.top-center{font-size:.95rem;color:#94a3b8}.top-center strong{color:#fff}
.cart-badge{background:#4caf5020;color:#4caf50;padding:3px 10px;border-radius:12px;font-size:.8rem;font-weight:600;margin-left:8px;cursor:pointer}
.top-right{display:flex;gap:12px;align-items:center}
.nav-link{color:#94a3b8;text-decoration:none;font-size:.85rem;padding:6px 12px;border-radius:6px}.nav-link:hover{color:#4caf50;background:#1e293b}
.logout-btn{background:none;border:1px solid #334155;color:#94a3b8;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:.85rem}.logout-btn:hover{border-color:#ef4444;color:#ef4444}
.main-layout{display:grid;grid-template-columns:1fr 380px;min-height:calc(100vh - 56px)}
.content{padding:32px;overflow-y:auto}
.section-title{font-size:1.4rem;font-weight:700;margin-bottom:20px;color:#fff}.section-title span{color:#ffd740}
.filter-bar{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.filter-btn{padding:6px 14px;background:#1e293b;border:1px solid #334155;border-radius:20px;color:#94a3b8;cursor:pointer;font-size:.8rem;transition:all .2s}.filter-btn:hover,.filter-btn.active{border-color:#4caf50;color:#4caf50;background:#4caf5010}
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:40px}
.product-card{background:#111827;border:1px solid #1e293b;border-radius:12px;padding:20px;transition:all .2s;cursor:pointer;display:flex;flex-direction:column;gap:12px}
.product-card:hover{border-color:#4caf50;transform:translateY(-2px);box-shadow:0 8px 30px rgba(76,175,80,.1)}
.product-card.owned{border-color:#4caf5040}
.product-icon{font-size:2rem}
.product-info h3{font-size:1rem;color:#fff;margin-bottom:4px}.product-info p{font-size:.8rem;color:#64748b}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:600;margin-top:6px}
.badge.available{background:#4caf5020;color:#4caf50}.badge.owned{background:#10b98120;color:#10b981}
.buy-btn{padding:8px 16px;border:none;border-radius:6px;color:#0a0e1a;font-weight:700;cursor:pointer;font-size:.85rem}.buy-btn:hover{opacity:.85}
.cart-btn{padding:8px 16px;background:none;border:1px solid #ffd740;border-radius:6px;color:#ffd740;cursor:pointer;font-size:.85rem;margin-top:4px}.cart-btn:hover{background:#ffd74010}
.manage-btn{padding:8px 16px;background:none;border:1px solid #334155;border-radius:6px;color:#94a3b8;cursor:pointer;font-size:.85rem}.manage-btn:hover{border-color:#4caf50;color:#4caf50}
/* Cart drawer */
.cart-drawer{display:none;padding:20px;background:#0f172a;border:1px solid #1e293b;border-radius:12px;margin-bottom:24px}
.cart-drawer.open{display:block}
.cart-drawer h3{color:#ffd740;margin-bottom:12px;font-size:1rem}
.cart-item{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #1e293b;font-size:.9rem}
.cart-item .ci-name{color:#fff}.cart-item .ci-price{color:#4caf50}.cart-item .ci-remove{background:none;border:none;color:#ef4444;cursor:pointer;font-size:.8rem}
.cart-total{display:flex;justify-content:space-between;padding:12px 0;font-weight:700;color:#fff;font-size:1rem}
.checkout-btn{width:100%;padding:12px;background:linear-gradient(135deg,#ffd740,#4caf50);color:#0a0e1a;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:1rem;margin-top:8px}
.checkout-btn:hover{box-shadow:0 4px 20px rgba(76,175,80,.3)}
.chat-panel{background:#111827;border-left:1px solid #1e293b;display:flex;flex-direction:column}
.chat-header{padding:16px 20px;border-bottom:1px solid #1e293b;display:flex;align-items:center;justify-content:space-between}
.chat-header h3{font-size:1rem;color:#fff;display:flex;align-items:center;gap:8px}
.specialist-status{width:8px;height:8px;border-radius:50%;display:inline-block}
.specialist-status.sleeping{background:#64748b;animation:pulse 3s infinite}.specialist-status.awake{background:#4caf50}.specialist-status.chatting{background:#4caf50;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.collapse-btn{background:none;border:none;color:#64748b;cursor:pointer;font-size:1.2rem}
.chat-messages{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
.chat-msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:.9rem;line-height:1.4;animation:fadeIn .3s}
.chat-msg.user{align-self:flex-end;background:#1e293b;color:#fff;border-bottom-right-radius:4px}
.chat-msg.specialist{align-self:flex-start;background:#4caf5010;color:#e0e0e0;border-bottom-left-radius:4px;border-left:2px solid #4caf50}
.chat-msg .name{font-size:.75rem;color:#4caf50;margin-bottom:4px;font-weight:600}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.typing-indicator{align-self:flex-start;padding:10px 14px;color:#64748b;font-size:.85rem}
.typing-indicator span{animation:typingDot 1.4s infinite;display:inline-block}.typing-indicator span:nth-child(2){animation-delay:.2s}.typing-indicator span:nth-child(3){animation-delay:.4s}
@keyframes typingDot{0%,100%{opacity:.3}50%{opacity:1}}
.chat-input-area{padding:12px 16px;border-top:1px solid #1e293b;display:flex;gap:8px}
.chat-input{flex:1;padding:10px 14px;background:#1e293b;border:1px solid #334155;border-radius:8px;color:#fff;font-size:.9rem;outline:none}.chat-input:focus{border-color:#4caf50}
.chat-send{padding:10px 18px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer}.chat-send:hover{background:#43a047}
.silos-section{margin-top:20px}
.silo-item{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#111827;border:1px solid #1e293b;border-radius:8px;margin-bottom:8px}
.silo-item .silo-icon{font-size:1.5rem}.silo-item .silo-name{font-weight:600;color:#fff;font-size:.9rem}.silo-item .silo-status{margin-left:auto;font-size:.75rem;color:#10b981}
.empty-silos{color:#475569;font-size:.9rem;text-align:center;padding:32px}
@media(max-width:768px){.main-layout{grid-template-columns:1fr}.chat-panel{position:fixed;right:0;top:56px;bottom:0;width:320px;transform:translateX(100%);transition:transform .3s;z-index:90}.chat-panel.open{transform:translateX(0)}.mobile-chat-toggle{display:block!important}}
.mobile-chat-toggle{display:none;position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#ffd740,#4caf50);color:#0a0e1a;border:none;font-size:1.5rem;cursor:pointer;z-index:95;box-shadow:0 4px 20px rgba(76,175,80,.3)}
</style>
</head>
<body>
<div class="top-bar">
  <div class="top-left"><span class="logo">serlf<span class="domain">.shop</span></span></div>
  <div class="top-center" id="greeting"></div>
  <div class="top-right">
    <a href="my-specialist.html" class="nav-link">üí¨ Specialist</a>
    <a href="my-marketplace.html" class="nav-link" style="color:#4caf50">üè™ Market</a>
    <button onclick="SerlfAuth.logout()" class="logout-btn">Logout</button>
  </div>
</div>
<div class="main-layout">
  <div class="content">
    <div class="section-title">üéØ <span>The Shop</span> ‚Äî Everything Available</div>
    <div class="cart-drawer" id="cartDrawer">
      <h3>üõí Your Cart</h3>
      <div id="cartItems"></div>
      <div class="cart-total"><span>Total</span><span id="cartTotal">$0</span></div>
      <button class="checkout-btn" onclick="doCheckout()">Checkout ‚Üí</button>
    </div>
    <div class="filter-bar" id="filterBar">
      <button class="filter-btn active" onclick="filterProducts('all')">All</button>
      <button class="filter-btn" onclick="filterProducts('dev')">Dev</button>
      <button class="filter-btn" onclick="filterProducts('ai')">AI</button>
      <button class="filter-btn" onclick="filterProducts('infra')">Infra</button>
      <button class="filter-btn" onclick="filterProducts('marketing')">Marketing</button>
      <button class="filter-btn" onclick="filterProducts('creative')">Creative</button>
      <button class="filter-btn" onclick="filterProducts('tools')">Tools</button>
      <button class="filter-btn" onclick="filterProducts('commerce')">Commerce</button>
    </div>
    <div class="product-grid" id="productGrid"></div>
    <div class="section-title">üì¶ Your <span>Silos</span></div>
    <div class="silos-section" id="silosSection"></div>
  </div>
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header"><h3><span class="specialist-status sleeping" id="specStatus"></span> Captain ‚Äî Your Specialist</h3><button class="collapse-btn" onclick="toggleChat()">‚úï</button></div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <input class="chat-input" id="chatInput" placeholder="Talk to Captain..." onkeydown="if(event.key==='Enter')sendMessage()">
      <button class="chat-send" onclick="sendMessage()">‚Üí</button>
    </div>
  </div>
</div>
<button class="mobile-chat-toggle" onclick="toggleChat()">üí¨</button>
<script src="../shared/auth.js"></script><script src="../shared/specialist-engine.js"></script><script src="../shared/marketplace-ui.js"></script><script src="../shared/stripe-flow.js"></script>
<script>
const user=SerlfAuth.requireAuth();if(!user)throw'';
let currentFilter='all';
const cart=StripeFlow.getCart();
document.getElementById('greeting').innerHTML=`Welcome back, <strong>${user.name||user.email.split('@')[0]}</strong> <span class="cart-badge" onclick="toggleCart()">üõí ${cart.length}</span>`;
renderProducts();renderSilos();renderCart();
SpecialistEngine.init('shop');const wakeMsg=SpecialistEngine.wake();
document.getElementById('specStatus').className='specialist-status awake';
addBotMessage(wakeMsg.message);
SpecialistEngine.getHistory().forEach(m=>{if(m.role==='user')addUserMessage(m.content);else if(m.role==='specialist')addBotMessage(m.content);});

function renderProducts(){
  const owned=user.ownedProducts||[];
  const products=MarketplaceUI.getProducts('shop');
  const filtered=currentFilter==='all'?products:products.filter(p=>p.category===currentFilter);
  document.getElementById('productGrid').innerHTML=filtered.map(p=>{
    const isOwned=owned.includes(p.id);
    const inCart=(user.cart||[]).includes(p.id);
    return`<div class="product-card ${isOwned?'owned':''}" data-id="${p.id}" data-cat="${p.category}">
      <div class="product-icon">${p.icon}</div>
      <div class="product-info"><h3>${p.name}</h3><p>${p.desc}</p>${isOwned?'<span class="badge owned">OWNED</span>':`<span class="badge available">$${p.price}/mo</span>`}</div>
      ${isOwned?'<button class="manage-btn">Manage ‚Üí</button>':`<button class="buy-btn" onclick="MarketplaceUI.buyProduct('${p.id}')" style="background:#4caf50">Get It</button>${!inCart?`<button class="cart-btn" onclick="addCart('${p.id}')">+ Add to Cart</button>`:''}`}
    </div>`;
  }).join('');
}
function filterProducts(cat){currentFilter=cat;document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');renderProducts();}
function addCart(id){StripeFlow.addToCart(id);renderCart();renderProducts();addBotMessage(`Added to cart. ${StripeFlow.getCart().length} items now. Want me to suggest a bundle?`);}
function renderCart(){
  const cart=StripeFlow.getCart();
  const drawer=document.getElementById('cartDrawer');
  if(!cart.length){drawer.classList.remove('open');return;}
  let total=0;
  document.getElementById('cartItems').innerHTML=cart.map(id=>{const p=MarketplaceUI.PRODUCTS[id];if(!p)return'';total+=p.price;return`<div class="cart-item"><span class="ci-name">${p.icon} ${p.name}</span><span class="ci-price">$${p.price}</span><button class="ci-remove" onclick="removeCart('${id}')">‚úï</button></div>`;}).join('');
  document.getElementById('cartTotal').textContent=`$${total}`;
}
function removeCart(id){StripeFlow.removeFromCart(id);renderCart();renderProducts();}
function toggleCart(){document.getElementById('cartDrawer').classList.toggle('open');}
async function doCheckout(){try{await StripeFlow.checkout();addBotMessage('All checked out. Your new silos are active. Nice haul.');renderProducts();renderSilos();renderCart();}catch(e){addBotMessage('Checkout issue: '+e);}}
function renderSilos(){const owned=(SerlfAuth.getUser()||{}).ownedProducts||[];const el=document.getElementById('silosSection');if(!owned.length){el.innerHTML='<div class="empty-silos">No silos yet. Start shopping!</div>';return;}el.innerHTML=owned.map(id=>{const p=MarketplaceUI.PRODUCTS[id];return p?`<div class="silo-item"><span class="silo-icon">${p.icon}</span><span class="silo-name">${p.name}</span><span class="silo-status">‚óè Active</span></div>`:'';}).join('');}
function addBotMessage(text){const el=document.createElement('div');el.className='chat-msg specialist';el.innerHTML=`<div class="name">üéØ Captain</div>${text.replace(/
/g,'<br>')}`;document.getElementById('chatMessages').appendChild(el);el.parentElement.scrollTop=el.parentElement.scrollHeight;}
function addUserMessage(text){const el=document.createElement('div');el.className='chat-msg user';el.textContent=text;document.getElementById('chatMessages').appendChild(el);el.parentElement.scrollTop=el.parentElement.scrollHeight;}
function showTyping(){const el=document.createElement('div');el.className='typing-indicator';el.id='typing';el.innerHTML='<span>.</span><span>.</span><span>.</span>';document.getElementById('chatMessages').appendChild(el);el.parentElement.scrollTop=el.parentElement.scrollHeight;}
function hideTyping(){const el=document.getElementById('typing');if(el)el.remove();}
function sendMessage(){const input=document.getElementById('chatInput'),text=input.value.trim();if(!text)return;input.value='';addUserMessage(text);document.getElementById('specStatus').className='specialist-status chatting';showTyping();setTimeout(()=>{hideTyping();const reply=SpecialistEngine.respond(text);addBotMessage(reply.content);document.getElementById('specStatus').className='specialist-status awake';},800+Math.random()*1200);}
function toggleChat(){document.getElementById('chatPanel').classList.toggle('open');}
function onProductBought(id){const p=MarketplaceUI.PRODUCTS[id];if(p){addBotMessage(`Done ‚Äî ${p.name} activated. ${p.icon}`);renderSilos();renderProducts();}}
</script>
</body></html>
